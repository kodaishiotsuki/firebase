<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat app</title>
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <h1>
      realtime chat
      <button id="login">Login</button>
      <button id="logout" style="display: none">Logout</button>
    </h1>
    <!-- 入力場所を作成しよう -->
    <form>
      <fieldset style="display: none">
        <legend>チャット入力画面</legend>
        <div>name: <input type="text" id="name" /></div>
        <div>text: <input type="text" id="text" /></div>
        <div>
          <button type="button" id="send">send</button>
        </div>
      </fieldset>
    </form>

    <!-- データ出力場所 -->
    <ul id="output"></ul>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        orderBy,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-firestore.js";
      const firebaseConfig = {
        apiKey: "AIzaSyDCObEVhS6w86DRYvY-KndTZjmEcYAXutc",
        authDomain: "work-291aa.firebaseapp.com",
        projectId: "work-291aa",
        storageBucket: "work-291aa.appspot.com",
        messagingSenderId: "752301912035",
        appId: "1:752301912035:web:3a355210340094e4897ad6",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      //送信ボタンを押してfirestoreにデータ送信
      $("#send").on("click", function () {
        // console.log("click");
        const data = {
          name: $("#name").val(),
          text: $("#text").val(),
          time: serverTimestamp(), //決まったもの
        };
        // console.log(data);
        addDoc(collection(db, "chat"), data);
        //↑何回も書いて覚える
        $("#text").val("");
        //textの中身を消す
      });
      //データ取得条件の指定（今回は時間の新しい順に並び替えて取得）
      const q = query(collection(db, "chat"), orderBy("time", "desc"));
      // console.log(q);
      /////////////////////////////////////// データ取得処理/////////////////////////////////////////
      // データに変更（追加，更新，削除など）が生じたタイミングで実行されるonSnapshot()を使用する．
      // onSnapshot()はデータベース上でデータの変更が発生したタイミングで{}内の処理を実行する．
      //////////⬇︎定数qを代入
      onSnapshot(q, collection(db, "chat"), (querySnapshot) => {
        // Firestore 上に保存されているデータを取得して console に出力する．
        // Firestore 上に保存されているデータはquerySnapshot.docsに入っている．
        console.log(querySnapshot.docs);
        ////////////////////////テータの取り出し（深いことは考えず、このまま使う）/////////////////////
        // 上記querySnapshot.docsは非常に複雑な形となっており，このまま扱うことは難しい．
        // そのため，必要なデータのみ抽出した「オブジェクト形式の配列」に変換する．
        //空の配列を準備
        const dataArray = [];
        // querySnapshot.docsに対して繰り返し処理を用いて各要素に対して，
        // .idでドキュメント ID（名前）を取得する．
        // .data()でドキュメント中身（3 項目）を取得する．
        querySnapshot.docs.forEach(function (doc) {
          const data = {
            id: doc.id,
            data: doc.data(),
          };
          // console.log(data);
          // 上記のデータのみを配列(dataArray)に追加．
          dataArray.push(data);
        });
        // console.log(dataArray);
        //画面表示するためのタグ表示
        //空の配列用意
        const tagArray = [];
        //dataArrayに繰り返しを用い，各要素をタグの形にする．
        dataArray.forEach(function (data) {
          tagArray.push(`
              <li id="${data.id}">
                  <p>${
                    data.data.name
                    //日時をいい感じの形式にする関数を出力
                  } at ${convertFromFirestoreTimestampToDatetime(data.data.time?.seconds)}</p>
                <p>${data.data.text}</p>
              </li>
                `);
          // 繰り返し処理終了後に指定した id 部分に出力する．
          $("#output").html(tagArray);
        });
      });

      ///////////////////////認証機能////////////////////////
      import { getAuth, signInAnonymously } from "firebase/auth";
      const auth = getAuth();
      signInAnonymously(auth)
        .then(() => {
          // Signed in..
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          // ...
        });
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in, see docs for a list of available properties
          // https://firebase.google.com/docs/reference/js/firebase.User
          const uid = user.uid;
          // ...
        } else {
          // User is signed out
          // ...
        }
      });
    </script>
    <script src="./js/main.js"></script>
  </body>
</html>
